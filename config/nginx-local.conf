# production server configuration
# we run separate nginx processes for production and staging
# because staging is something that we only do occasionally
# it also provides better compartmentalization at the filesystem
# level because it allows us to run each nginx process as a
# different user
user rails.wincent.com rails.wincent.com;
worker_processes 4;
pid /var/run/nginx.pid;

events {
  worker_connections  1024;
}

http {
  include       mime.types;
  default_type  application/octet-stream;

  # mimic the Apache "combined" log format, so log analysis tools can grok it:
  #  "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
  #  - IP address of the client (remote host)
  #  - RFC 1413 identity of client (identd)
  #  - userid of person making the request (HTTP authentication)
  #  - request time; for example: [10/Oct/2000:13:55:36 -0700]
  #    [2-digit day/3-letter month/4-digit year:2-digit hour:2-digit minute:2-digit second +/-4-digit zone]
  #  - request line (method, resource, protocol)
  #  - status code
  #  - returned object size
  #  - Referer from HTTP request header
  #  - User-Agent from HTTP request header
  log_format combined_proxy '$remote_addr - $remote_user [$time_local] "$request" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for"';

  sendfile on;
  tcp_nopush on; # defaults to off (when on, useful for prepending headers before calling sendfile)

  gzip on;
  gzip_types text/plain
             text/html
             text/javascript
             text/css
             text/xml
             application/x-javascript
             application/xml
             application/xml+atom
             application/xml+rss;
  gzip_proxied any; # default is "off" (no compression on proxied requests)

  upstream mongrels {
    server 209.235.214.137:53422;
    server 209.235.214.137:53423;
    server 209.235.214.137:53424;
    server 209.235.214.137:53425;
  }

  server {
    listen 209.235.214.137;
    server_name rails.wincent.com; # later will be wincent.com/www.wincent.com
    root /home/rails.wincent.com/deploy/current/public;
    client_body_temp_path /home/rails.wincent.com/deploy/shared/client_body_temp;
    fastcgi_temp_path /home/rails.wincent.com/deploy/shared/fast_cgi_temp;
    proxy_temp_path /home/rails.wincent.com/deploy/shared/proxy_temp;
    access_log /home/rails.wincent.com/deploy/shared/log/access_log combined_proxy;
    error_log /home/rails.wincent.com/deploy/shared/log/error_log notice;
    error_page 500 502 503 504 /500.html;

    # show maintenance page (added by Capistrano) if present
    if (-f $document_root/system/maintenance.html) {
      rewrite ^(.*)$ /system/maintenance.html last;
      break;
     }

    location / {

      index index.html;

      # forward client info otherwise Rails won't see it
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_max_temp_file_size 0;

      # serve static content without hitting Rails
      location ~ ^/(images|javascripts|stylesheets)/ {
        expires 10y;
      }
      if (-f $request_filename) {
        break;
      }

      # cached pages
      if (-f $request_filename.html) {
        rewrite (.*) $1.html break;
      }

      # everything else goes to the mongrel cluster
      if (!-f $request_filename) {
        proxy_pass http://mongrels;
        break;
      }

    } # end: location
  } # end: server

  # HTTPS server
  #server {
  #    listen       443;
  #    server_name  localhost;
  #    ssl                  on;
  #    ssl_certificate      cert.pem;
  #    ssl_certificate_key  cert.key;
  #    ssl_session_timeout  5m;
  #    ssl_protocols  SSLv2 SSLv3 TLSv1;
  #    ssl_ciphers  ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
  #    ssl_prefer_server_ciphers   on;
  #    location / {
  #        root   html;
  #        index  index.html index.htm;
  #    }
  #}

} # end: http


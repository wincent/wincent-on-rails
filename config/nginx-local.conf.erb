worker_processes 4;
pid <%= ENV['RAILS_ROOT'] %>/tmp/nginx.pid;

events {
  worker_connections  256;
}

error_log <%= ENV['RAILS_ROOT'] %>/log/error_log notice;

http {
  include       mime.types;
  default_type  application/octet-stream;
  sendfile on;
  tcp_nopush on; # defaults to off (when on, useful for prepending headers before calling sendfile)

  gzip on;
  gzip_types text/plain
             text/html
             text/javascript
             text/css
             text/xml
             application/x-javascript
             application/xml
             application/xml+atom
             application/xml+rss;
  gzip_proxied any; # default is "off" (no compression on proxied requests)

  upstream mongrels {
    server 127.0.0.1:3000;
  }

  server {
    listen 127.0.0.1:3001;
    server_name rails.wincent.local;
    rewrite ^/(.*) https://localhost:3002/$1 permanent;
    client_body_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/client_body_temp;
    fastcgi_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/fast_cgi_temp;
    proxy_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/proxy_temp;
    access_log <%= ENV['RAILS_ROOT'] %>/log/access_log;
  } # end: server

  server {
    listen 127.0.0.1:3002;
    ssl on;
    ssl_certificate <%= ENV['RAILS_ROOT'] %>/config/local/ssl.crt;
    ssl_certificate_key <%= ENV['RAILS_ROOT'] %>/config/local/ssl.key;
    server_name rails.wincent.local;
    root <%= ENV['RAILS_ROOT'] %>/public;
    client_body_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/client_body_temp;
    fastcgi_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/fast_cgi_temp;
    proxy_temp_path <%= ENV['RAILS_ROOT'] %>/tmp/proxy_temp;
    access_log <%= ENV['RAILS_ROOT'] %>/log/access_log;
    error_page 500 502 503 504 /500.html;

    # show maintenance page (added by Capistrano) if present
    if (-f $document_root/system/maintenance.html) {
      rewrite ^(.*)$ /system/maintenance.html last;
      break;
     }

    location / {

      index index.html;

      # forward client info otherwise Rails won't see it
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header Host $http_host;
      proxy_set_header X_FORWARDED_PROTO https;
      proxy_max_temp_file_size 0;

      # serve static content without hitting Rails
      location ~ ^/(images|javascripts|stylesheets)/ {
        expires 10y;
      }
      if (-f $request_filename) {
        break;
      }

      # cached pages
      set $cache_extension '';
      if ($request_method = GET) {
        set $cache_extension '.html';
      }

      # the above is a hack because nginx doesn't allow nested or ANDed ifs
      if (-f $request_filename$cache_extension) {
        rewrite (.*) $1.html break;
      }

      # everything else goes to the mongrel cluster
      proxy_pass http://mongrels;

    } # end: location
  } # end: server
} # end: http

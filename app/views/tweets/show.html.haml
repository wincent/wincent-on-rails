-content_for :javascript do
  =javascript_include_tag 'ajax'
  :javascript
    // TODO: extract this function into ajax.js and call it from here
    $(function() {
      var comment_div = $('#comment-form');
      var anchor = comment_div.find('a');
      anchor.attr('href', '#comment-form');
      var click = function() {
        anchor.unbind('click');
        comment_div.append('<img alt="Spinner" id="spinner" class="spinner" src="/images/spinner.gif" />');
        var spinner = comment_div.find('#spinner');
        spinner.show();
        $.ajax({
          'url': '/twitter/#{@tweet.id}/comments/new',
          'type': 'get',
          'dataType': 'html',
          'success': function(html) {
            comment_div.html(html);
          },
          'error': function(req) {
            insertAJAXFlash('error', req.responseText);
            spinner.remove();
            anchor.click(click);
          }
        });
      }
      anchor.click(click);
    });
%h1 Tweet
%div[@tweet]
  =@tweet.body.w
  .when=timeinfo @tweet
=render 'shared/tags', :tags => @tweet.tags
-# Gravatar and user profile link
-# cf: http://twitter.com/sstephenson/status/1227528821
.links
  =link_to 'all tweets', tweets_path
-if @tweet.accepts_comments? || @tweet.comments_count != 0
  =named_anchor 'comments'
  %h2.major
    Comments
    =feed_icon tweet_path(@tweet, :format => :atom)
  .comments
    -for comment in @comments
      %div{ :class => "comment " + (comment.user && comment.user.superuser? ? 'admin' : cycle('even', 'odd')), :id => "comment_#{comment.id}" }
        %blockquote=comment.body.w :base_heading_level => 2
        %cite
          =link_to_user comment.user
          %span.when=timeinfo comment, :updated_string => 'edited'
  %h2.major Add a comment
  #ajax-flash
  #comment-form
    .links=link_to 'add a comment', new_tweet_comment_path(@tweet)

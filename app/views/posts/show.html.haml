-if @post.public?
  -atom_link @post
.post
  -@page_title = @post.title
  %h1.major=h @post.title
  .when=timeinfo @post
  .excerpt=excerpt_html
  .body=body_html
.cloud
  %h1 Tags
  -# consider moving this into a partial
  -for tag in @post.tags
    =scaled_tag tag
%p.links
  -if admin?
    =link_to 'edit', edit_post_url(@post), :class => 'edit_link'
  =link_to 'all posts', posts_url, :class => 'back_link'
-if @post.accepts_comments? || @post.comments_count != 0
  -# TODO: use divs to color-code comments (ie. private, awaiting moderation etc)
  =named_anchor 'comments'
  %h2.major
    Comments
    =feed_icon post_url(@post, :format => :atom)
  %table.comments
    -for comment in @post.comments.published
      -next if comment.new_record? # BUG: when is this ever true?
      %tr{ :class => "comment #{cycle('even', 'odd')}" + (comment.public? ? '' : ' private'), :id => "comment_#{comment.id}" }
        %th
          =link_to_user comment.user
          %br
          =pluralizing_count(comment.user.utterances_count, 'post') if comment.user
          %br
          %span.when=timeinfo comment, :updated_string => 'edited'
          -if admin?
            %br
            =link_to 'edit', edit_comment_url(comment)
            -# TODO: add a means of marking individual comments as private
        %td=comment.body.w :base_heading_level => 2
  %h2.major Add a comment
  -if @comment
    =render :partial => 'comments/comment'
  -else
    -# comments are currently closed but they were open in the past because we have at least one existing comment
    %p==Comments are closed for this post. You can discuss this further in the #{link_to 'forums', forums_url}.

.post
  -page_title @post.title
  .when=timeinfo @post
  .excerpt=excerpt_html
  .body=body_html
.cloud
  %h1 Tags
  -# consider moving this into a partial
  -for tag in @post.tags
    =scaled_tag tag
%p.links
  -if admin?
    =link_to 'edit', edit_blog_path(@post), :class => 'edit_link'
  =link_to 'back', blog_index_path, :class => 'back_link'
-if !@post.accepts_comments?
  -if @post.comments_count != 0
    =named_anchor 'comments'
    %h2 Comments
    %p
      Comments closed for this post. You can discuss this further in the forums.
      -# TODO: add forums link
-else
  =named_anchor 'comments'
  %h2 Comments
  .comment_info
    ==#{comment_count @post.comments.published_count} published, #{comment_count @post.comments.unmoderated_count} awaiting moderation, #{comment_count @post.comments.spam_count} marked as spam
  -for comment in (admin? ? @post.comments.ham : @post.comments.published)
    -next if comment.new_record?
    %div{:id => "comment_#{comment.id}"}
      .comment
        .body=preserve comment.body.w
        .info==Posted by #{comment.user.display_name} at #{comment.created_at}
        -admin_only do
          .links
            =link_to 'edit', edit_blog_comment_path(@post, comment), :class => 'edit_link'
            =link_to 'destroy', blog_comment_path(@post, comment), :confirm => 'Are you sure?', :method => :delete, :class => 'destroy_link'
            -if comment.awaiting_moderation?
              %form{:id => "comment_#{comment.id}_spam_form"}
                =submit_to_remote 'button', 'spam', :url => blog_comment_path(@post, comment), :method => 'put', :failure => "alert('Failed to mark as spam')"
              %form{:id => "comment_#{comment.id}_ham_form"}
                =submit_to_remote 'button', 'ham', :url => blog_comment_path(@post, comment), :method => 'put', :failure => "alert('Failed to mark as ham')"
  -if @comment
    =render :partial => 'comments/comment'
  -else
    %p
      =link_to 'login', login_path(:original_uri => blog_path(@post))
      to post a comment
